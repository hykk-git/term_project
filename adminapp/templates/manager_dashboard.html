<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Manager Dashboard</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dongle&family=Nanum+Gothic&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Dongle&family=Jua&family=Nanum+Gothic&display=swap');
        body {
            font-family: "Nanum Gothic", sans-serif;
        }
        .text-center {
            font-family: "Jua", sans-serif;
        }
        .fade-out {
            transition: opacity 2s ease-out;
            opacity: 0;
        }
    </style>
    <script>
        function closeAnnouncementModal() {
            document.getElementById('announcementModal').style.display = 'none';
        }

        function showSuccessPopup(message) {
            const successPopup = document.getElementById('successPopup');
            successPopup.innerText = message;
            successPopup.style.display = 'block';
            setTimeout(() => {
                successPopup.classList.add('fade-out');
                setTimeout(() => {
                    successPopup.style.display = 'none';
                    successPopup.classList.remove('fade-out');
                }, 2000);
            }, 1000);
        }

        function sendAnnouncement(event) {
            event.preventDefault();
            const content = document.getElementById('content').value;
            const target_user = document.getElementById('target_user').value;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("{% url 'manager_dashboard' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({ content: content, target_user: target_user }).toString()
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccessPopup(data.success);
                    closeAnnouncementModal();
                } else {
                    alert('오류가 발생했습니다.');
                }
            });
        }

        function confirmDeleteGroup() {
            if (confirm("정말 삭제하시겠습니까?")) {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                fetch("{% url 'delete_group' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccessPopup(data.success);
                        setTimeout(() => {
                            window.location.href = "{% url 'home' %}";
                        }, 2000);
                    } else {
                        alert('오류가 발생했습니다.');
                    }
                });
            }
        }
    </script>
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center">{{ group_name }}가 진행 중~</h2>
        {% if unconfirmed_users.exists %}
        <div class="text-center mt-2">
            <span class="unconfirmed-users">
                {{ unconfirmed_users.count }}명의 사용자가 아직 자신의 마니또를 확인하지 않았어요!
                <div class="unconfirmed-user-list">
                    {% for user in unconfirmed_users %}
                    <p>{{ user.username }}</p>
                    {% endfor %}
                </div>
            </span>
        </div>
        {% else %}
        <div class="text-center mt-2">
            <span class="confirmed-users">
                모두가 자신의 마니또를 확인했어요!
            </span>
        </div>
        {% endif %}
        <div class="text-center mt-4">
            <button class="btn btn-primary" onclick="document.getElementById('announcementModal').style.display='block'">공지사항 보내기</button>
            <button class="btn btn-danger" onclick="confirmDeleteGroup()">그룹 삭제하기</button>
        </div>
        <div class="mt-5">
            <h3>최근 공지사항</h3>
            <ul class="list-group">
                {% for announcement in announcements %}
                <li class="list-group-item">
                    {{ announcement.content }}
                    <form method="post" action="{% url 'delete_announcement' announcement.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm">삭제</button>
                    </form>
                </li>
                {% empty %}
                <li class="list-group-item">공지사항이 없습니다.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- 공지사항 모달 -->
    <div id="announcementModal" class="modal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">공지사항 보내기</h5>
                    <button type="button" class="btn-close" onclick="closeAnnouncementModal()"></button>
                </div>
                <div class="modal-body">
                    <form method="post" onsubmit="sendAnnouncement(event)">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="content">메시지</label>
                            <textarea class="form-control" id="content" name="content" required></textarea>
                        </div>
                        <div class="form-group mt-3">
                            <label for="target_user">대상 사용자 (선택 사항)</label>
                            <select class="form-control" id="target_user" name="target_user">
                                <option value="">전체 사용자</option>
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">전송</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 성공 팝업 -->
    <div id="successPopup" style="display: none; position: fixed; top: 20px; right: 20px; background: green; color: white; padding: 10px; border-radius: 5px;">
    </div>
</body>
</html>
